var fs = require("fs");
var http = require("http");

var mock = require("./lib/");
var request = require("request");
var formidable = require("formidable");

mock({
    "test.zip": fs.readFileSync("test.zip"),
});

var server = http.createServer(function(req, res) {
    var form = new formidable.IncomingForm();

    // binding.writeBuffers is called somewhere inside here
    form.parse(req, function() {
        res.writeHead(200, {"Content-Type": "text/plain"});
        res.end("DONE");
    });
});

server.listen(4321, function() {
    request.post({
        url: "http://localhost:4321/",
        formData: {
            file: fs.createReadStream("test.zip"),
        },
    }, function(err, res, body) {
        console.log(res.statusCode, body);
        process.exit();
    });
});
